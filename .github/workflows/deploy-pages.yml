name: Deploy Pages (manual)

on:
  workflow_dispatch:
    inputs:
      source:
        description: 'Source artifact to deploy (artifact name or "pages")'
        required: false
        default: 'pages'
      source_branch:
        description: 'Repository branch to deploy (used when building from source)'
        required: false
        default: 'main'
      use_artifact:
        description: 'Use previously uploaded artifact if available (true|false)'
        required: false
        default: 'false'
      force:
        description: 'Force deploy even if no changes (true|false)'
        required: false
        default: 'false'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  deploy:
    name: Deploy to GitHub Pages (manual approval)
    runs-on: ubuntu-latest
    environment:
      name: production
    env:
      # Prefer repository Variables, fall back to Secrets. Support both CRA and Vite naming.
      REACT_APP_FIREBASE_API_KEY: ${{ vars.REACT_APP_FIREBASE_API_KEY || secrets.REACT_APP_FIREBASE_API_KEY }}
      REACT_APP_FIREBASE_AUTH_DOMAIN: ${{ vars.REACT_APP_FIREBASE_AUTH_DOMAIN || secrets.REACT_APP_FIREBASE_AUTH_DOMAIN }}
      REACT_APP_FIREBASE_PROJECT_ID: ${{ vars.REACT_APP_FIREBASE_PROJECT_ID || secrets.REACT_APP_FIREBASE_PROJECT_ID }}
      REACT_APP_FIREBASE_STORAGE_BUCKET: ${{ vars.REACT_APP_FIREBASE_STORAGE_BUCKET || secrets.REACT_APP_FIREBASE_STORAGE_BUCKET }}
      REACT_APP_FIREBASE_MESSAGING_SENDER_ID: ${{ vars.REACT_APP_FIREBASE_MESSAGING_SENDER_ID || secrets.REACT_APP_FIREBASE_MESSAGING_SENDER_ID }}
      REACT_APP_FIREBASE_APP_ID: ${{ vars.REACT_APP_FIREBASE_APP_ID || secrets.REACT_APP_FIREBASE_APP_ID }}

      VITE_FIREBASE_API_KEY: ${{ vars.VITE_FIREBASE_API_KEY || secrets.VITE_FIREBASE_API_KEY || vars.REACT_APP_FIREBASE_API_KEY || secrets.REACT_APP_FIREBASE_API_KEY }}
      VITE_FIREBASE_AUTH_DOMAIN: ${{ vars.VITE_FIREBASE_AUTH_DOMAIN || secrets.VITE_FIREBASE_AUTH_DOMAIN || vars.REACT_APP_FIREBASE_AUTH_DOMAIN || secrets.REACT_APP_FIREBASE_AUTH_DOMAIN }}
      VITE_FIREBASE_PROJECT_ID: ${{ vars.VITE_FIREBASE_PROJECT_ID || secrets.VITE_FIREBASE_PROJECT_ID || vars.REACT_APP_FIREBASE_PROJECT_ID || secrets.REACT_APP_FIREBASE_PROJECT_ID }}
      VITE_FIREBASE_STORAGE_BUCKET: ${{ vars.VITE_FIREBASE_STORAGE_BUCKET || secrets.VITE_FIREBASE_STORAGE_BUCKET || vars.REACT_APP_FIREBASE_STORAGE_BUCKET || secrets.REACT_APP_FIREBASE_STORAGE_BUCKET }}
      VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ vars.VITE_FIREBASE_MESSAGING_SENDER_ID || secrets.VITE_FIREBASE_MESSAGING_SENDER_ID || vars.REACT_APP_FIREBASE_MESSAGING_SENDER_ID || secrets.REACT_APP_FIREBASE_MESSAGING_SENDER_ID }}
      VITE_FIREBASE_APP_ID: ${{ vars.VITE_FIREBASE_APP_ID || secrets.VITE_FIREBASE_APP_ID || vars.REACT_APP_FIREBASE_APP_ID || secrets.REACT_APP_FIREBASE_APP_ID }}

      # Build metadata exported for Settings page
      REACT_APP_BUILD_BRANCH: ${{ github.event.inputs.source_branch || github.ref_name }}
      REACT_APP_BUILD_SHA: ${{ github.sha }}
      REACT_APP_BUILD_TAG: ${{ github.ref_type == 'tag' && github.ref_name || '' }}
      REACT_APP_BUILD_TIME: ${{ github.run_started_at }}
      VITE_BUILD_BRANCH: ${{ github.event.inputs.source_branch || github.ref_name }}
      VITE_BUILD_SHA: ${{ github.sha }}
      VITE_BUILD_TAG: ${{ github.ref_type == 'tag' && github.ref_name || '' }}
      VITE_BUILD_TIME: ${{ github.run_started_at }}
    steps:
      - name: Compute safe ref
        id: compute_ref
        run: |
          set -euo pipefail
          RAW="${{ github.event.inputs.source_branch || 'main' }}"
          if [[ "$RAW" =~ ^[A-Za-z0-9._\/-]{1,100}$ ]]; then
            BR="$RAW"
          else
            echo "Invalid branch name; defaulting to main"
            BR="main"
          fi
          if ! git ls-remote --heads "https://github.com/${GITHUB_REPOSITORY}.git" "$BR" | grep -q "$BR"; then
            echo "Branch '$BR' not found; defaulting to main"
            BR="main"
          fi
          echo "DEPLOY_BRANCH=$BR" >> "$GITHUB_ENV"
          echo "SAFE_REF=refs/heads/$BR" >> "$GITHUB_ENV"

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # Check out the requested source branch directly to avoid building the wrong ref
          ref: main

      - name: Switch to deploy branch
        run: |
          set -euo pipefail
          BR="${{ env.DEPLOY_BRANCH }}"
          if [ "$BR" != "main" ]; then
            echo "Switching to sanitized branch: $BR"
            git fetch --depth=1 origin "$BR":"refs/remotes/origin/$BR"
            git checkout -f "$BR"
          else
            echo "Using main branch checkout"
          fi

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          # Align with project engines to avoid unexpected build issues
          node-version: '18'

      - name: Set build metadata env
        run: |
          set -euo pipefail
          BRANCH="${{ env.DEPLOY_BRANCH || github.ref_name }}"
          COMMIT="${{ github.sha }}"
          TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo '')
          TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          echo "REACT_APP_BUILD_BRANCH=$BRANCH" >> "$GITHUB_ENV"
          echo "REACT_APP_BUILD_SHA=$COMMIT" >> "$GITHUB_ENV"
          echo "REACT_APP_BUILD_TAG=$TAG" >> "$GITHUB_ENV"
          echo "REACT_APP_BUILD_TIME=$TIME" >> "$GITHUB_ENV"
          echo "VITE_BUILD_BRANCH=$BRANCH" >> "$GITHUB_ENV"
          echo "VITE_BUILD_SHA=$COMMIT" >> "$GITHUB_ENV"
          echo "VITE_BUILD_TAG=$TAG" >> "$GITHUB_ENV"
          echo "VITE_BUILD_TIME=$TIME" >> "$GITHUB_ENV"

      - name: Debug Firebase env presence
        run: |
          set -euo pipefail
          check() { var="$1"; val="${!var:-}"; if [ -n "$val" ]; then echo "$var: set"; else echo "$var: MISSING"; fi }
          echo "Checking Firebase environment variables (values not shown):"
          check REACT_APP_FIREBASE_API_KEY
          check REACT_APP_FIREBASE_AUTH_DOMAIN
          check REACT_APP_FIREBASE_PROJECT_ID
          # Build Info injection is verified after copying build output

      - name: Debug Firebase env presence
        run: |
          set -e
          echo "Checking Firebase env presence (values hidden):"
          for key in \
            REACT_APP_FIREBASE_API_KEY REACT_APP_FIREBASE_AUTH_DOMAIN REACT_APP_FIREBASE_PROJECT_ID \
            REACT_APP_FIREBASE_STORAGE_BUCKET REACT_APP_FIREBASE_MESSAGING_SENDER_ID REACT_APP_FIREBASE_APP_ID \
            VITE_FIREBASE_API_KEY VITE_FIREBASE_AUTH_DOMAIN VITE_FIREBASE_PROJECT_ID \
            VITE_FIREBASE_STORAGE_BUCKET VITE_FIREBASE_MESSAGING_SENDER_ID VITE_FIREBASE_APP_ID; do
            if [ -n "${!key:-}" ]; then
              echo "$key: set"
            else
              echo "$key: MISSING"
            fi
          done

      - name: Download pages artifact (optional)
        if: ${{ github.event.inputs.use_artifact == 'true' }}
        uses: actions/download-artifact@v4
        with:
          name: ${{ github.event.inputs.source }}
          path: ./artifact_build
        continue-on-error: true

      - name: Prepare deploy directory
        run: |
          set -euo pipefail
          export GIT_EMAIL="41898282+github-actions[bot]@users.noreply.github.com"
          export GIT_NAME="github-actions[bot]"
          git config --global user.email "$GIT_EMAIL"
          git config --global user.name "$GIT_NAME"

          TMPDIR=$(mktemp -d)
          REPO_URL="https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"

          echo "Cloning gh-pages branch into $TMPDIR"
          git clone --branch gh-pages --single-branch "$REPO_URL" "$TMPDIR" || (
            git clone "$REPO_URL" "$TMPDIR"
            cd "$TMPDIR"
            git checkout --orphan gh-pages
          )

          # clear old content
          rm -rf "$TMPDIR"/*

          # prefer artifact contents if present
          if [ -d ./artifact_build ] && [ "$(ls -A ./artifact_build)" ]; then
            echo "Using downloaded artifact contents for deployment"
            cp -r ./artifact_build/* "$TMPDIR"/
          else
            echo "No suitable artifact found or artifact disabled — building from source branch"
            # At this point the repository is checked out to the requested branch (deploy-source) if it existed
            # Use `npm install` here instead of `npm ci` so deploy-only runs don't fail
            # when the lockfile and environment differ (CI environments can have slight
            # package resolution differences). This is intentional for deploy-only jobs.
            npm install --no-audit --no-fund
            # Explicitly export build metadata envs into this step to ensure CRA inlines them
            BRANCH="${{ env.DEPLOY_BRANCH || github.ref_name }}"
            COMMIT="${{ github.sha }}"
            TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo '')
            TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)
            export REACT_APP_BUILD_BRANCH="$BRANCH"
            export REACT_APP_BUILD_SHA="$COMMIT"
            export REACT_APP_BUILD_TAG="$TAG"
            export REACT_APP_BUILD_TIME="$TIME"
            export VITE_BUILD_BRANCH="$BRANCH"
            export VITE_BUILD_SHA="$COMMIT"
            export VITE_BUILD_TAG="$TAG"
            export VITE_BUILD_TIME="$TIME"
            # Run craco build directly to avoid invoking npm lifecycle scripts
            # (prebuild runs lint/format which can fail in deploy-only contexts).
            npx craco build
            # Inject build metadata into index.html and write build-info.json
            node scripts/inject-build-info.mjs
            cp -r ./build/* "$TMPDIR"/
          fi

          # Verify postbuild injection artifacts from scripts/inject-build-info.mjs
          echo "Verifying Build Info injection in deploy directory"
          if [ -f "$TMPDIR/index.html" ]; then
            if grep -q "window.__BUILD_INFO__" "$TMPDIR/index.html"; then
              echo "Postbuild Build Info injection detected in index.html"
            else
              echo "ERROR: Build Info not injected into index.html. Ensure postbuild script runs."
              exit 1
            fi
          else
            echo "ERROR: index.html missing in deploy directory"
            exit 1
          fi
          if [ -f "$TMPDIR/build-info.json" ]; then
            echo "build-info.json present"
          else
            echo "WARNING: build-info.json missing — runtime fallback may be unavailable"
          fi

          cd "$TMPDIR"
          git add --all

          if [ "${{ github.event.inputs.force }}" != 'true' ] && git diff --staged --quiet; then
            echo "No changes to deploy"
            # compute a likely preview URL and show it to the operator
            OWNER="${GITHUB_REPOSITORY%%/*}"
            REPO_NAME="${GITHUB_REPOSITORY##*/}"
            PREVIEW_URL="https://${OWNER}.github.io/${REPO_NAME}/"
            echo "Preview URL: ${PREVIEW_URL}"
            echo "If you still want to force a deploy, re-run this workflow with 'force=true' or use the gh CLI example below."
            echo "gh workflow run deploy-pages.yml -f source=${{ github.event.inputs.source }} -f source_branch=${{ github.event.inputs.source_branch }} -f use_artifact=${{ github.event.inputs.use_artifact }} -f force=true"
            exit 0
          fi

          # Commit changes (if any)
          git commit -m "chore(pages): deploy ${{ github.event.inputs.source_branch || github.ref }} (${{ github.sha }})" || echo "Nothing to commit"

          # Try a normal push first; only force if user explicitly requested it
          if [ "${{ github.event.inputs.force }}" = 'true' ]; then
            echo "Force push requested — pushing with --force"
            git push origin gh-pages --force
            # echo preview URL after force push as well
            OWNER="${GITHUB_REPOSITORY%%/*}"
            REPO_NAME="${GITHUB_REPOSITORY##*/}"
            PREVIEW_URL="https://${OWNER}.github.io/${REPO_NAME}/"
            echo "Deployed (force) — Preview URL: ${PREVIEW_URL}"
          else
            echo "Attempting non-forced push to gh-pages"
            if git push origin gh-pages; then
              echo "Successfully pushed gh-pages"
              # show preview url and guidance to operator
              OWNER="${GITHUB_REPOSITORY%%/*}"
              REPO_NAME="${GITHUB_REPOSITORY##*/}"
              PREVIEW_URL="https://${OWNER}.github.io/${REPO_NAME}/"
              echo "Preview URL: ${PREVIEW_URL}"
              echo "If this deploy should override history, re-run with:"
              echo "gh workflow run deploy-pages.yml -f source=${{ github.event.inputs.source }} -f source_branch=${{ github.event.inputs.source_branch }} -f use_artifact=${{ github.event.inputs.use_artifact }} -f force=true"
            else
              echo "Push rejected (non-fast-forward). To override and force a deploy, re-run this workflow with the 'force' input set to true."
              echo "You can re-run via the UI or with gh CLI, e.g.:"
              echo "gh workflow run deploy-pages.yml -f source=${{ github.event.inputs.source }} -f source_branch=${{ github.event.inputs.source_branch }} -f use_artifact=${{ github.event.inputs.use_artifact }} -f force=true"
              exit 1
            fi
          fi

      - name: Health check (Pages)
        run: |
          set -euo pipefail
          OWNER="${GITHUB_REPOSITORY%%/*}"
          REPO_NAME="${GITHUB_REPOSITORY##*/}"
          PREVIEW_URL="https://${OWNER}.github.io/${REPO_NAME}/"
          TARGET_URL="${PREVIEW_URL}build-info.json"
          echo "Health check: ${TARGET_URL}"
          # retry for up to ~2 minutes to allow propagation
          success=0
          for i in $(seq 1 12); do
            status=$(curl -s -o /tmp/bi.json -w "%{http_code}" "$TARGET_URL" || true)
            if [ "$status" = "200" ]; then
              # basic content validation
              if grep -q '"branch"' /tmp/bi.json && grep -q '"sha"' /tmp/bi.json; then
                echo "Health check passed: build-info.json contains branch and sha"
                success=1
                break
              fi
            fi
            echo "Attempt $i failed (status=$status). Waiting..."
            sleep 10
          done
          if [ "$success" -ne 1 ]; then
            echo "ERROR: build-info.json not reachable or invalid after retries"
            echo "Checked URL: $TARGET_URL"
            exit 1
          fi

      - name: Finish
        run: echo "Deployment finished"
