name: Deploy Firestore Rules (manual)

on:
  workflow_dispatch:
    inputs:
      project_id:
        description: 'Firebase Project ID to deploy to'
        required: false
        default: ''

jobs:
  deploy:
    name: Deploy Firestore Security Rules
    runs-on: ubuntu-latest
    env:
      # Allow setting project via input or repository variable
      FIREBASE_PROJECT_ID: ${{ github.event.inputs.project_id != '' && github.event.inputs.project_id || vars.FIREBASE_PROJECT_ID }}
    steps:
      - uses: actions/checkout@v4

      - name: Ensure project id is present
        run: |
          set -euo pipefail
          if [ -z "${FIREBASE_PROJECT_ID:-}" ]; then
            echo "FIREBASE_PROJECT_ID not provided. Set repo variable FIREBASE_PROJECT_ID or pass input 'project_id'." >&2
            exit 1
          fi
          echo "Using project: $FIREBASE_PROJECT_ID"

      - name: Install Firebase CLI
        run: npm i -g firebase-tools

      - name: Deploy Firestore rules via CLI
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        run: |
          set -euo pipefail
          if [ -z "${FIREBASE_TOKEN:-}" ]; then
            echo "ERROR: FIREBASE_TOKEN secret not configured. Generate with 'firebase login:ci' and add as repo secret FIREBASE_TOKEN." >&2
            exit 1
          fi
          firebase deploy --only firestore:rules -P "$FIREBASE_PROJECT_ID"

      - name: Finish
        run: echo "Firestore rules deployed to ${FIREBASE_PROJECT_ID}"
